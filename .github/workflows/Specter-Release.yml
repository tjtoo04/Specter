name: Release CLI

on:
  push:
    branches: [ "main" ] # Run tests on main branch pushes
    tags: [ "v*" ]       # Trigger release on tags like v1.0.0
  pull_request:

permissions:
  contents: write # Required to upload files to Releases

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./cli # Point to your Go module root

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for GoReleaser to check git history

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache-dependency-path: cli/go.sum # Explicit path for caching

      # 1. CI Step: Run Tests (Runs on every push)
      - name: Run Tests
        run: go test ./... -v

      # 2. CI Step: Verify Build
      - name: Verify Build
        # ADD "-o /dev/null" to discard the binary after building
        run: go build -v -o /dev/null ./cmd/specter

      # 3. CD Step: Run GoReleaser (Only runs on tags v*)
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        if: startsWith(github.ref, 'refs/tags/')
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
          workdir: ./cli # CRITICAL: Tells GoReleaser where go.mod lives
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}